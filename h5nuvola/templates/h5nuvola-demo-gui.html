<html>
<head>
    <title>h5nuvola WebGUI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Load W3 CSS framework and font awesome -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Load jquery FileTree plugin -->
    <script src="{{ url_for('static', filename='js_libraries/jquery-2.2.4.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js_libraries/jquery.fileTree-1.01/jquery.easing.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js_libraries/jquery.fileTree-1.01/jqueryFileTree.js') }}" type="text/javascript"></script>
    <link href="{{ url_for('static', filename='js_libraries/jquery.fileTree-1.01/jqueryFileTree.css') }}" rel="stylesheet" type="text/css" media="screen" />
    <!-- include jsTree | css theme and source -->    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
    <!-- load Bokeh CSS stylesheets -->
    <link href="https://cdn.pydata.org/bokeh/release/bokeh-1.2.0.css" rel="stylesheet" type="text/css">
    <link href="https://cdn.pydata.org/bokeh/release/bokeh-widgets-1.2.0.css" rel="stylesheet" type="text/css">
    <link href="https://cdn.pydata.org/bokeh/release/bokeh-tables-1.2.0.css" rel="stylesheet" type="text/css">
    <!-- include Bokeh js source -->
    <script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-1.2.0.js"></script>
    <script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-widgets-1.2.0.js"></script>
    <script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-tables-1.2.0.js"></script>
    <script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-api-1.2.0.js"></script>
    <script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-gl-1.2.0.js"></script>
</head>
<body>

<div class="w3-sidebar w3-bar-block w3-card w3-animate-left w3-mobile" style="display:none;" id="fileTreeSidebar">
    <button class="w3-bar-item w3-button w3-large w3-mobile w3-blue w3-hover-black" style="display:inline; position: sticky; top: 0;"
    onclick="hideFileTree()">Close &times;</button>
    <div class="w3-bar-item w3-container w3-xxlarge" id="fileTree" >Remote Storage</div>
</div>

<div class="w3-sidebar w3-bar-block w3-card w3-animate-left w3-mobile" style="display:none;" id="H5FilesSidebar">
    <button class="w3-bar-item w3-button w3-large w3-mobile w3-blue w3-hover-black" style="display:inline; position: sticky; top: 0;"
    onclick="hideH5Files()">Close &times;</button>
    <div class="w3-bar-item w3-container w3-large" id="h5Tree"></div>
    <button class="w3-bar-item w3-button w3-large" onclick="addTab()">Add Tab</button>
    <div class="w3-bar-item w3-card w3-blue" style="position: sticky; bottom: 0;">
        <div class="w3-container">
            <ul id="hf_attributes" style="list-style: none;">Attributes:</ul>
            <button class="w3-button" id="raw_button">Raw</button>
            <button class="w3-button" id="curve_button">Curve</button>
            <button class="w3-button" id="image_button">Image</button>
        </div>
    </div>
</div>

<div class="w3-mobile" id="main">

    <div class="w3-blue" id="mainButtons">
        <button id="showFileTree" class="w3-button w3-xlarge w3-hover-black" onclick="showFileTree()">&#9776; File Browser</button>
        <button id="showH5Files" class="w3-button w3-xlarge w3-hover-black" onclick="showH5Files()">&#9776; h5 Files</button> 
        <button id="settings" class="w3-button w3-xlarge w3-right w3-hover-black fa fa-cog"></button>        
        <div class="w3-dropdown-hover w3-xlarge w3-right">
            <button class="w3-button w3-hover-black fa fa-user-o"></button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4">
                <a href="/logout" class="w3-bar-item w3-button">Logout</a>                
            </div>
        </div>
        <button id="option1" class="w3-button w3-xlarge w3-right w3-hover-black">Option1</button>
        <button id="option2" class="w3-button w3-xlarge w3-right w3-hover-black">Option2</button>
        <div class="w3-dropdown-hover w3-xlarge w3-right">
            <button class="w3-button w3-hover-black">Dropdown</button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4">
                <a href="#" class="w3-bar-item w3-button">Link 1</a>
                <a href="#" class="w3-bar-item w3-button">Link 2</a>
                <a href="#" class="w3-bar-item w3-button">Link 3</a>
            </div>
        </div>
    </div>

    <div class="w3-bar w3-black" id="mainTabs" style="border: 1px solid black;">
        <button id="tab-button-001" class="w3-bar-item w3-button tablink w3-red" onclick="openTab('001')">Python API</button>
        
    </div>

    <div class="w3-container" id="tabsContent">
        <div id="tab-content-001" class="w3-container w3-display-container tab">
            <span onclick="removeTab('001')" class="w3-button w3-large w3-display-topright fa fa-close"></span>
            <h2 class="w3-text-red">Python API</h2>
            <p>Python API</p>
        </div>        
    </div>

</div>



<script type="text/javascript">
    // HTML elements variables
    var divMain = document.getElementById("main");
    var divMainButtons = document.getElementById("mainButtons");
    var divMainTabs = document.getElementById("mainTabs");
    var tabsContent = document.getElementById("tabsContent");
    var buttonShowFileTree = document.getElementById("showFileTree");
    var fileTreeSidebar = document.getElementById("fileTreeSidebar");
    var buttonShowH5Files = document.getElementById("showH5Files");
    var H5FilesSidebar = document.getElementById("H5FilesSidebar");

    var raw_button = document.getElementById("raw_button");
    var curve_button = document.getElementById("curve_button");
    var image_button = document.getElementById("image_button");

    // Global variables
    var rootDir = "../"; // root directory to browse
    var hfDict = {}; // hf new items to be added to the tree
    var node_clicked = ''; // current node clicked       

    function showFileTree() {
        if (H5FilesSidebar.style.display == "none") {
            buttonShowH5Files.style.marginLeft = "25%";
            divMainTabs.style.marginLeft = "25%";
            tabsContent.style.marginLeft = "25%";
            fileTreeSidebar.style.width = "50%";
        } else {
            divMainTabs.style.marginLeft = "50%";
            tabsContent.style.marginLeft = "50%";
            H5FilesSidebar.style.marginLeft = "25%";       
            H5FilesSidebar.style.width = "25%";
            fileTreeSidebar.style.width = "25%";            
        }                
        
        fileTreeSidebar.style.display = "block";
        buttonShowFileTree.style.display = "none";
    }

    function hideFileTree() {
        if (H5FilesSidebar.style.display == "none") {
            buttonShowH5Files.style.marginLeft = "0%";
            divMainTabs.style.marginLeft = "0%";
            tabsContent.style.marginLeft = "0%";
            H5FilesSidebar.style.width = "25%";
            buttonShowFileTree.style.marginLeft = "0%";
        } else {
            divMainButtons.style.marginLeft = "0%";
            divMainTabs.style.marginLeft = "25%";
            tabsContent.style.marginLeft = "25%";
            H5FilesSidebar.style.marginLeft = "0%";
            H5FilesSidebar.style.width = "50%";
            buttonShowFileTree.style.marginLeft = "25%";
        }                        
        fileTreeSidebar.style.display = "none";
        buttonShowFileTree.style.display = "inline-block";
    }

    function showH5Files() {
        if (fileTreeSidebar.style.display == "none") {
            buttonShowFileTree.style.marginLeft = "25%";
            divMainTabs.style.marginLeft = "25%";
            tabsContent.style.marginLeft = "25%";
            H5FilesSidebar.style.marginLeft = "0%";           
        } else {
            divMainTabs.style.marginLeft = "50%";
            tabsContent.style.marginLeft = "50%";
            H5FilesSidebar.style.marginLeft = "25%";       
            H5FilesSidebar.style.width = "25%";
            fileTreeSidebar.style.width = "25%";
        }
        H5FilesSidebar.style.width = "30%";       
        H5FilesSidebar.style.display = "block";
        buttonShowH5Files.style.display = "none";
    }

    function hideH5Files() {
        if (fileTreeSidebar.style.display == "none") {
            divMainTabs.style.marginLeft = "0%";
            tabsContent.style.marginLeft = "0%";
            buttonShowFileTree.style.marginLeft = "0%";
            buttonShowH5Files.style.marginLeft = "0%";
        } else {            
            divMainTabs.style.marginLeft = "25%";
            tabsContent.style.marginLeft = "25%";
            buttonShowH5Files.style.marginLeft = "25%";
            fileTreeSidebar.style.width = "50%";
        }
        //divMainButtons.style.marginLeft = "0%";
        H5FilesSidebar.style.display = "none";        
        buttonShowH5Files.style.display = "inline-block";        
    }

    function addTab(tabDetails, tabName) {
        var tabID = Math.random().toString(36).substring(7);
        
        // Create new Tab Button
        var newTabButton = document.createElement("button");
        newTabButton.setAttribute("id", "tab-button-" + tabID)
        newTabButton.setAttribute("class", "w3-bar-item w3-button tablink");
        newTabButton.setAttribute("onclick", "openTab('" + tabID + "')" );
        newTabButton.innerHTML = tabName;
        divMainTabs.appendChild(newTabButton);

        // Create new Tab Content
        var newTabDiv = document.createElement("div");
        newTabDiv.setAttribute("id", "tab-content-" + tabID);
        newTabDiv.setAttribute("class", "w3-container w3-display-container tab");
        
        var newTabContent = document.createElement("h2");        
        newTabContent.innerHTML = tabDetails + "    ->    " + tabName;
        newTabDiv.appendChild(newTabContent);

        var newTabPlot = document.createElement("div");
        newTabPlot.setAttribute("id", "tab-plot-" + tabID);
        newTabPlot.setAttribute("class", "w3-container w3-display-container");
        newTabDiv.appendChild(newTabPlot);
        
        var newTabClose = document.createElement("span");
        newTabClose.setAttribute("onclick", "removeTab('" + tabID + "')");
        newTabClose.setAttribute("class", "w3-button w3-large w3-display-topright fa fa-close");        
        newTabDiv.appendChild(newTabClose);

        // Append New Tab Div
        tabsContent.appendChild(newTabDiv);

        // Show new tab's content
        openTab(tabID);
        return tabID;
    }

    function openTab(tabID) {
        
        var tabButtonID = "tab-button-" + tabID;
        var tabContentID = "tab-content-" + tabID;

        var i, tabs, tablinks;
        var tabs = document.getElementsByClassName("tab");
        var tablinks = document.getElementsByClassName("tablink");
        for (i = 0; i < tabs.length; i++) {
            tabs[i].style.display = "none";
            tablinks[i].className = tablinks[i].className.replace(" w3-red", "");
        }
        document.getElementById(tabButtonID).className += " w3-red";
        document.getElementById(tabContentID).style.display = "block";       
    }

    function removeTab(tabID) {
        var tabButtonID = "tab-button-" + tabID;
        var tabContentID = "tab-content-" + tabID
        var toRemoveTab = document.getElementById(tabContentID);
        var toRemoveButton = document.getElementById(tabButtonID);
        var activeTab = toRemoveButton.previousElementSibling;       
        toRemoveTab.parentNode.removeChild(toRemoveTab);
        toRemoveButton.parentNode.removeChild(toRemoveButton);
        openTab(activeTab.id.split("-").pop());
    }

    function jsTreeCustomMenu(node) {
        var items = {
            "raw": {
                "label": "Raw",
                "action": function () {
                    console.log("Raw");
                }
            },
            "curve": {
                "label": "Curve",
                "action": function () {
                    console.log("Curve");
                }
            },
            "image": {
                "label": "Image",
                "action": function () {
                    console.log("Image");
                }
            }
        }
        return items;
    }

    function populateH5TreeRoot(hfDict) {
        
        // create root node
        var root_id = $('#h5Tree').jstree().create_node('#', {            
            text: hfDict.root_properties[0],
            icon: "{{ url_for('static', filename='hdf_icons/hdf5.gif') }}",
            state: {
                opened: true,
                disabled: false,
                selected: false
            },
            a_attr: {
                "type": "file",
                "obj_filepath": hfDict.filepath,
                "obj_path": "/",
                "obj_attributes": hfDict.root_properties[2],
                "obj_dtype": hfDict.root_properties[4],
                "obj_dshape": hfDict.root_properties[5]
                }
        });
        
        // ad hf_root_items to root node
        var icon='';
        var type='';
        for(var i=0; i <= hfDict.hf_root_items.length-1; i++) {
            if (hfDict.hf_root_items[i][1] == "group") {
                if (hfDict.hf_root_items[i][2].length >= 1) {                                
                    icon = "{{ url_for('static', filename='hdf_icons/foldercloseA.gif') }}";
                } else {                    
                    icon = "{{ url_for('static', filename='hdf_icons/folderclose.gif') }}";
                }                            
                type='group';
            } else {
                if (hfDict.hf_root_items[i][4] == 'string') {                    
                    icon = "{{ url_for('static', filename='hdf_icons/text.gif') }}";
                } else {                            
                    if (hfDict.hf_root_items[i][2].length >= 1) {                        
                        icon = "{{ url_for('static', filename='hdf_icons/datasetA.gif') }}";
                    } else {                        
                        icon = "{{ url_for('static', filename='hdf_icons/dataset.gif') }}";
                    }
                }                            
                type='dataset';
            }
            var text = hfDict.hf_root_items[i][0];                    
            text = text.split('/');
            text = text[text.length - 1];                        
            var node = $('#h5Tree').jstree().create_node(root_id, {                        
                text: text,
                icon: icon,
                //children: hf_root_items[i][3],                                               
                state: {
                    opened: hfDict.hf_root_items[i][3],
                    disabled: false,
                    selected: false
                },
                a_attr: {"type": type,
                        "obj_filepath": hfDict.filepath,
                        "obj_path": hfDict.hf_root_items[i][0],
                        "obj_attributes": hfDict.hf_root_items[i][2],
                        "obj_dtype": hfDict.hf_root_items[i][4],
                        "obj_dshape": hfDict.hf_root_items[i][5]
                }
            }, "last");
        }        
        showH5Files();                
    }

    function populateH5Node(hfDict) {
        console.log("populateH5Node");
        // ad hf_new_items to selected node
        var icon='';
        var type='';
        for(var i=0; i <= hfDict.hf_new_items.length-1; i++) {
            if (hfDict.hf_new_items[i][1] == "group") {
                if (hfDict.hf_new_items[i][2].length >= 1) {                                
                    icon = "{{ url_for('static', filename='hdf_icons/foldercloseA.gif') }}";
                } else {                    
                    icon = "{{ url_for('static', filename='hdf_icons/folderclose.gif') }}";
                }                            
                type='group';
            } else {
                if (hfDict.hf_new_items[i][4] == 'string') {                    
                    icon = "{{ url_for('static', filename='hdf_icons/text.gif') }}";
                } else {                            
                    if (hfDict.hf_new_items[i][2].length >= 1) {                        
                        icon = "{{ url_for('static', filename='hdf_icons/datasetA.gif') }}";
                    } else {                        
                        icon = "{{ url_for('static', filename='hdf_icons/dataset.gif') }}";
                    }
                }                            
                type='dataset';
            }
            var text = hfDict.hf_new_items[i][0];                    
            text = text.split('/');
            text = text[text.length - 1];                        
            var node = $('#h5Tree').jstree().create_node(node_clicked.id, {                        
                text: text,
                icon: icon,
                //children: hf_root_items[i][3],                                               
                state: {
                    opened: hfDict.hf_new_items[i][3],
                    disabled: false,
                    selected: false
                },
                a_attr: {"type": type,
                        "obj_filepath": hfDict.filepath,
                        "obj_path": hfDict.hf_new_items[i][0],
                        "obj_attributes": hfDict.hf_new_items[i][2],
                        "obj_dtype": hfDict.hf_new_items[i][4],
                        "obj_dshape": hfDict.hf_new_items[i][5]
                }
            }, "last");

        }
    }
    
    // routine to refresh obj_attributes
    function showObjAttributes(node) {         
        document.getElementById("hf_attributes").innerHTML = "";
        raw_button.style.display = "inline";
        curve_button.style.display = "inline";
        image_button.style.display = "inline";
        // dataset name
        var h5 = document.createElement("h5");
        h5.innerText = node.text;
        h5.style["fontWeight"] = "bold";
        document.getElementById("hf_attributes").appendChild(h5);
        var li = document.createElement("li");
        li.innerText = node.a_attr.obj_dtype + ', ' +  node.a_attr.obj_dshape;                    
        document.getElementById("hf_attributes").appendChild(li);
        for (var i =0; i<=node.a_attr.obj_attributes.length-1; i++) {
            var li = document.createElement("li");
            var key = document.createElement("a");
            var sep = document.createElement("a");
            var value = document.createElement("a");
            key.innerText = node.a_attr.obj_attributes[i][0];
            sep.innerHTML = " : ";
            value.innerText = node.a_attr.obj_attributes[i][1];
            li.appendChild(key);
            li.appendChild(sep);
            li.appendChild(value);
            document.getElementById("hf_attributes").appendChild(li);
        }        
        var shape = eval(node.a_attr.obj_dshape);
        console.log(shape.length);
        switch(shape.length) {
            case 0:
                console.log("Shape is 0");
                curve_button.style.display = "none";
                image_button.style.display = "none";
                break;
            case 1:
                console.log("Shape is 1");                
                image_button.style.display = "none";
                break;
            case 2:
                console.log("Shape is 2");                
                break;
            case 3:
                console.log("Shape is 3");
                break;
            default:
                console.log("Object has no shape");
                raw_button.style.display = "none";
                curve_button.style.display = "none";
                image_button.style.display = "none";
        }
    };

    $(document).ready( function() {
        console.log("document.ready")
        openTab("001");        

        // Load jquery FileTree - Remote file browsing
        $('#fileTree').fileTree({
            root: rootDir,
            script: "{{ url_for('remotebrowse') }}",
            },
            function(file) {
                filepath = file;
                console.log("open h5 file: " + filepath);
                request('/loadH5File', {filepath:filepath}, 'POST')
            }            
        );

        // Load jquery jsTree - h5 files tree view
        $('#h5Tree').jstree({
            "core" : {
                "check_callback": true,
                "multiple": false
            },
            "checkbox": {
                "visible": true
            },
            // "plugins": ["contextmenu"],
            // "contextmenu": {
            //     "items": jsTreeCustomMenu
            // }
        });

        // Set action for every time a node is selected
        $('#h5Tree').on("select_node.jstree", function (e, data) {
            // pick selected node object           
            node_clicked = $('#h5Tree').jstree(true).get_node(data.selected[0]);
            
            // display obj_attributes (HDF attributes)
            showObjAttributes(node_clicked);

            // expand node if it has children                  
            if((node_clicked.a_attr.type == "group")&&(node_clicked.children.length == 0)) {
                request( '/h5treeUpdate',
                        {                            
                            filepath: node_clicked.a_attr.obj_filepath,
                            node: node_clicked.a_attr.obj_path,
                        },
                        'POST' );                            
            }
        })
        .jstree();
        
        // Define plotting calls/requests
        $('#raw_button').on('click', function() {
            console.log('raw data');            
            request('/raw',
                    {
                        filepath: node_clicked.a_attr.obj_filepath,
                        node: node_clicked.a_attr.obj_path,
                    },
                    'POST');
        });
        $('#curve_button').on('click', function() {
            console.log('curve data');
            request('/curve',
                    {
                        filepath: node_clicked.a_attr.obj_filepath,
                        node: node_clicked.a_attr.obj_path,
                    },
                    'POST');
        });
        $('#image_button').on('click', function() {
            console.log('image data');
            request('/image',
                    {
                        filepath: node_clicked.a_attr.obj_filepath,
                        node: node_clicked.a_attr.obj_path,
                    },
                    'POST');
        });
    
    });

    function request(path, params, method) {                   

        var form = document.createElement("form");
        form.setAttribute("method", method);
        form.setAttribute("action", path);

        for(var key in params) {
            if(params.hasOwnProperty(key)) {
                var hiddenField = document.createElement("input");
                hiddenField.setAttribute("type", "hidden");
                hiddenField.setAttribute("name", key);
                hiddenField.setAttribute("value", params[key]);

                form.appendChild(hiddenField);
            }
        }                   

        $.ajax({
            url: path,
            method: method,
            data: $(form).serialize()
        }).success(function(data, textStatus, jqXHR) {                                        
            if (path == '/loadH5File') {
                console.log('/loadH5File');
                hfDict = JSON.parse(data);
                if (Object.keys(hfDict).length === 0) {
                    console.log("File already opened!")                    
                } else {
                    populateH5TreeRoot(hfDict);
                }                
            }
            else if (path == '/h5treeUpdate') {
                hfDict = JSON.parse(data);
                console.log(hfDict);
                if (hfDict.hf_new_items[0] === "1") {
                    console.log("Empty group");
                } else {
                    populateH5Node(hfDict);
                }
            }
            else if (path == '/raw') {
                tabID = addTab(node_clicked.a_attr.obj_filepath.split('/').pop(),
                                node_clicked.a_attr.obj_path
                                );
                tabPlotID = "tab-plot-" + tabID;                
                item = JSON.parse(data);                                
                Bokeh.embed.embed_item(item[0], tabPlotID);               
            }
            else if (path == '/curve') {
                tabID = addTab(node_clicked.a_attr.obj_filepath.split('/').pop(),
                                node_clicked.a_attr.obj_path
                                );
                tabPlotID = "tab-plot-" + tabID;
                item = JSON.parse(data);
                Bokeh.embed.embed_item(item[0], tabPlotID);
            }
            else if (path == '/image') {
                tabID = addTab(node_clicked.a_attr.obj_filepath.split('/').pop(),
                                node_clicked.a_attr.obj_path
                                );
                tabPlotID = "tab-plot-" + tabID;                
                item = JSON.parse(data);                                
                Bokeh.embed.embed_item(item[0], tabPlotID);
            }

        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log(errorThrown);
        });
    };
    
    
</script>

</body>
</html> 